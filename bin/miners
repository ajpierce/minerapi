#!/usr/bin/env python

import json
from socket import socket as skt, AF_INET, SOCK_STREAM, SHUT_RDWR, error as skterr
import re
import sys

BUFFER_SIZE = 4096
HEADERS = "rig port pool worker gpu status Mh/s gpu% fan fan% temp reject% hwerrs memspd gpuspd int".split()


class Miner:

    def __init__(self, host, port):
        self.endpoint = (host, port)

    def request(self, command, arg=None):
        """Send command to miner and return parsed response."""
        response = None
        miner = skt(AF_INET, SOCK_STREAM)

        try:
            miner.connect(self.endpoint)
            miner.send(self._instruction(command, arg))
            response = self._response(miner)
        except Exception as err:
            raise
        finally:
            miner.shutdown(SHUT_RDWR)
            miner.close()

        return response

    def _response(self, miner_socket):
        """Read response from socket."""
        response = ''
        while True:
            buff = miner_socket.recv(BUFFER_SIZE)
            if not buff:
                break
            response += buff
        # throw away last \0 byte if there was a response
        return json.loads(response[:-1]) if len(response) else None

    def _instruction(self, command, arg=None):
        """Construct command to pass to a miner."""
        cmd = {'command': command}
        if arg is not None:
            cmd['parameter'] = arg
        return json.dumps(cmd)


class Console:
    """Format and print output to the console."""

    def __init__(self):
        pass

    def gpu_line(self, righost, rigport, pooldict, gpudict):
        """Print formatted data for one GPU."""
        spec = self._format_spec()
        data = {'rig-instance': '%s:%s' % (righost, rigport)}
        for k, v in pooldict.iteritems():
            data[k] = v
        for k, v in gpudict.iteritems():
            data[k] = v
        return spec.format(**data)

    def _format_spec(self):
        """Return format spec for GPU data."""
        format_parts = [
                '{rig-instance:<20}',
                '{GPU:^3}',
                '{pool:<25}',
                '{worker:<20}',
                '{Status:<6}',
                '{MHS 5s:4.2f}',
                '{GPU Activity:>4}%',
                '{Fan Speed:>5}',
                '{Fan Percent:>4}%',
                '{Temperature:3.0f}',
                '{Device Rejected%:> 7.2f}',
                '{Hardware Errors:>4}',
                '{Memory Clock:>4}',
                '{GPU Clock:>4}',
                '{Intensity:>3}',
        ]
        return ' '.join(format_parts)


def device_line(line_tuple):
    """Format tuple of device data for the console, guided by HEADERS."""
    return '%-15s %-5s %-25s %-20s %-3s %-6s %-4s %4s %5s %4s %4s %7s %6s %6s %6s %3s' % line_tuple


def device_tuple(host, port, pool_dict, device_dict):
    """Extract the tuple for printing to console."""
    line_parts = [host, port, pool_dict['pool'], pool_dict['worker']]
    fields = [
            'GPU',
            'Status',
            'MHS 5s',
            'GPU Activity',
            'Fan Speed',
            'Fan Percent',
            'Temperature',
            'Device Rejected%',
            'Hardware Errors',
            'Memory Clock',
            'GPU Clock',
            'Intensity',
            ]
    for fld in fields:
        line_parts.append(device_dict[fld])
    return tuple(line_parts)


def pool_info(pools_response):
    """Extract key meta info from 'pools' response.""" 
    info = {}
    primary_pool = pools_response['POOLS'][0]
    url = re.match('.*://(.*)', primary_pool['URL'])
    info['pool'] = url.group(1) if url else None
    info['worker'] = primary_pool['User']
    return info


def run():

    console = Console()

    miners = [
            {'host': '192.168.121.20', 'port': 4028},
            {'host': '192.168.121.21', 'port': 4028},
            {'host': '192.168.121.22', 'port': 4028},
            {'host': '192.168.121.15', 'port': 4028},
    ]

    print device_line(tuple(HEADERS))
    print '-' * 138

    for rig in miners:
        host, port = (rig['host'], rig['port'])
        miner = Miner(host, port)

        try:
            pools_response = miner.request('pools')
            device_response = miner.request('devs')
            pool = pool_info(pools_response)
            devices = device_response['DEVS']
        except skterr as err:
            print '%s:%s not responding' % (host, port)
            sys.exit(1)
        except KeyboardInterrupt as err:
            sys.exit(0)

        for dev in devices:
#            line = device_tuple(host, port, pool, dev)
            print console.gpu_line(host, port, pool, dev)


if __name__ == '__main__':
    run()
